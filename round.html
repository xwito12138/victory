<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŒ«memeçš„å›½åº¦ - ROUND</title>
    <style>
        body {
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #F2E8D3;
            font-family: 'Microsoft YaHei', sans-serif;
            overflow: hidden;
        }

        .title {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 64px;
            color: #663F2A;
            font-weight: bold;
            z-index: 1000;
            display: flex;
            gap: 15px;
        }

        .title span {
            display: inline-block;
            animation: jump 0.5s ease-in-out;
            animation-fill-mode: both;
        }

        @keyframes jump {
            0% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-20px);
            }
            100% {
                transform: translateY(0);
            }
        }

        .main-container {
            position: relative;
            width: 800px;
            height: 600px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.5s ease;
        }

        #imageElement, #gifElement {
            position: absolute;
            width: 400px;
            height: 400px;
            object-fit: contain;
            transition: all 0.5s ease;
        }

        #imageElement {
            opacity: 1;
        }

        #gifElement {
            opacity: 0;
        }

        .video-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 320px;
            height: 240px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }

        #videoElement {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        .instructions {
            margin-top: 30px;
            font-size: 24px;
            color: #663F2A;
            text-align: center;
            max-width: 600px;
            display: none;
        }

        .progress-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 800px;
            height: 30px;
            background-color: #DC7F43;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: #F2E8D3;
            transition: width 0.3s ease;
        }

        .status-text {
            position: fixed;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            color: #663F2A;
            text-align: center;
            transition: color 0.3s ease;
            z-index: 10;
        }

        .game-over {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 48px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .game-over.active {
            opacity: 1;
        }

        .game-over button {
            margin-top: 30px;
            padding: 15px 30px;
            font-size: 24px;
            background-color: #DC7F43;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .game-over button:hover {
            background-color: #B35A2E;
        }

        /* å¼€å‘è€…å¿«æ·é€šé“æŒ‰é’®æ ·å¼ */
        .dev-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 10px 15px;
            background-color: #663F2A;
            color: #F2E8D3;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            z-index: 1000;
            opacity: 0.7;
            transition: opacity 0.3s ease;
            pointer-events: auto;
        }

        .dev-button:hover {
            opacity: 1;
            background-color: #B35A2E;
        }

        .dev-button:active {
            transform: scale(0.95);
        }

        /* ç»“å°¾æ¼”å‡ºæ ·å¼ */
        .ending-show {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #F2E8D3;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .ending-show.active {
            opacity: 1;
        }

        .ending-gifs {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 300px;
            position: relative;
        }

        .ending-gif {
            width: 400px;
            height: 400px;
            margin: 0 20px;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.5s ease;
        }

        .ending-gif.active {
            opacity: 1;
            transform: scale(1);
        }

        .cat-emoji {
            position: absolute;
            font-size: 120px;
            bottom: -50px;
            animation: riseUp 2s ease-out forwards;
        }

        @keyframes riseUp {
            0% {
                transform: translateY(0);
                opacity: 0;
            }
            20% {
                opacity: 1;
            }
            100% {
                transform: translateY(-500px);
                opacity: 0;
            }
        }

        .falling-gif {
            position: absolute;
            width: 200px;
            height: 200px;
            top: -200px;
            animation: fallDown 3s ease-in forwards;
        }

        @keyframes fallDown {
            0% {
                transform: translateY(0) rotate(0deg);
            }
            100% {
                transform: translateY(calc(100vh - 200px)) rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <div class="title">
        <span>o</span>
        <span>i</span>
        <span>i</span>
        <span>a</span>
        <span>i</span>
        <span>i</span>
        <span>o</span>
        <span>o</span>
    </div>
    <div class="main-container">
        <img id="imageElement" src="æ›¿æ¢.png" alt="æ›¿æ¢">
        <img id="gifElement" src="3.gif" alt="3">
    </div>
    <div class="instructions">
        è¯·åœ¨å›¾ç‰‡å˜ä¸º3.gifæ—¶æ—‹è½¬ä¸ŠåŠèº«ï¼Œåœ¨å›¾ç‰‡å˜ä¸ºæ›¿æ¢.pngæ—¶ä¿æŒé™æ­¢
    </div>

    <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    <div class="status-text" id="statusText">å‡†å¤‡å¼€å§‹...</div>

    <div class="video-container">
        <video id="videoElement" autoplay playsinline></video>
    </div>

    <!-- å¼€å‘è€…å¿«æ·é€šé“æŒ‰é’® -->
    <button class="dev-button" onclick="activateDevMode()">å¼€å‘è€…å¿«æ·é€šé“</button>

    <div class="game-over" id="gameOver">
        <div>æ¸¸æˆç»“æŸ</div>
        <button id="restartButton">é‡æ–°å¼€å§‹</button>
    </div>

    <!-- ç»“å°¾æ¼”å‡ºå®¹å™¨ -->
    <div class="ending-show" id="endingShow">
        <div class="ending-gifs">
            <img src="3.gif" class="ending-gif" id="endingGif1" alt="3">
            <img src="3.gif" class="ending-gif" id="endingGif2" alt="3">
            <img src="3.gif" class="ending-gif" id="endingGif3" alt="3">
        </div>
    </div>

    <script>
        // è·å–DOMå…ƒç´ 
        const video = document.getElementById('videoElement');
        const imageElement = document.getElementById('imageElement');
        const gifElement = document.getElementById('gifElement');
        const progressBar = document.getElementById('progressBar');
        const statusText = document.getElementById('statusText');
        const gameOver = document.getElementById('gameOver');
        const restartButton = document.getElementById('restartButton');
        const mainContainer = document.querySelector('.main-container');
        const endingShow = document.getElementById('endingShow');
        const endingGif1 = document.getElementById('endingGif1');
        const endingGif2 = document.getElementById('endingGif2');
        const endingGif3 = document.getElementById('endingGif3');
        
        // æ¸¸æˆçŠ¶æ€å˜é‡
        let isGifVisible = false;
        let isRotating = false;
        let gameActive = true;
        let progress = 0;
        let imageSize = 400;
        let switchInterval;
        let endingShowActive = false;
        
        // è¯·æ±‚æ‘„åƒå¤´æƒé™
        async function setupCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'user',
                        width: { ideal: 320 },
                        height: { ideal: 240 }
                    } 
                });
                video.srcObject = stream;
                return new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve(video);
                    };
                });
            } catch (error) {
                console.error('æ— æ³•è®¿é—®æ‘„åƒå¤´:', error);
                alert('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·ç¡®ä¿å·²æˆäºˆæ‘„åƒå¤´æƒé™ã€‚');
            }
        }

        // éšæœºåˆ‡æ¢å›¾ç‰‡
        function switchImages() {
            if (!gameActive) return;
            
            // éšæœºå†³å®šæ˜¯å¦åˆ‡æ¢å›¾ç‰‡
            isGifVisible = !isGifVisible;
            
            // æ›´æ–°å›¾ç‰‡å¯è§æ€§
            if (isGifVisible) {
                imageElement.style.opacity = 0;
                gifElement.style.opacity = 1;
                statusText.textContent = "oiiçŒ«æ­£åœ¨æ—‹è½¬ï¼Œä½ å¯ä»¥å‰è¿›äº†ï¼ï¼";
                statusText.style.color = "#DC7F43";
            } else {
                imageElement.style.opacity = 1;
                gifElement.style.opacity = 0;
                statusText.textContent = "oiiçŒ«æ­£åœ¨å‡è§†ä½ ï¼Œä¸è¦ç›´è§†å®ƒçš„çœ¼ç›ï¼Ÿï¼Ÿ";
                statusText.style.color = "#663F2A";
            }
            
            // æ¯æ¬¡åˆ‡æ¢åå¢åŠ å›¾ç‰‡å¤§å°
            imageSize += 10; // æ¯æ¬¡åˆ‡æ¢å¢åŠ 10åƒç´ 
            imageElement.style.width = `${imageSize}px`;
            imageElement.style.height = `${imageSize}px`;
            gifElement.style.width = `${imageSize}px`;
            gifElement.style.height = `${imageSize}px`;
            
            // è®¾ç½®ä¸‹ä¸€æ¬¡åˆ‡æ¢çš„éšæœºæ—¶é—´ï¼ˆ1-10ç§’ï¼‰
            const nextSwitchTime = Math.floor(Math.random() * 9000) + 1000;
            switchInterval = setTimeout(switchImages, nextSwitchTime);
        }

        // æ£€æµ‹æ—‹è½¬
        function detectRotation() {
            // åˆ›å»ºä¸€ä¸ªç”»å¸ƒæ¥åˆ†æè§†é¢‘å¸§
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d', { willReadFrequently: true });
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // æ—‹è½¬æ£€æµ‹å˜é‡
            let lastFrameData = null;
            
            // ç”¨äºè®¡ç®—æ—‹è½¬è§’åº¦çš„å‡½æ•°
            function calculateRotationAngle(currentFrameData, lastFrameData) {
                if (!lastFrameData) return 0;
                
                // ä½¿ç”¨å…‰æµç®—æ³•æˆ–ç®€å•çš„åƒç´ å·®å¼‚æ¥ä¼°è®¡æ—‹è½¬
                let diffSum = 0;
                let pixelCount = 0;
                
                // åªåˆ†æä¸ŠåŠéƒ¨åˆ†åŒºåŸŸï¼ˆå‡è®¾ä¸ŠåŠèº«åœ¨è§†é¢‘çš„ä¸ŠåŠéƒ¨åˆ†ï¼‰
                const upperHalfHeight = Math.floor(canvas.height / 2);
                
                for (let y = 0; y < upperHalfHeight; y += 5) {
                    for (let x = 0; x < canvas.width; x += 5) {
                        const currentPixel = currentFrameData.data[(y * canvas.width + x) * 4];
                        const lastPixel = lastFrameData.data[(y * canvas.width + x) * 4];
                        
                        // è®¡ç®—åƒç´ å·®å¼‚
                        const diff = Math.abs(currentPixel - lastPixel);
                        
                        diffSum += diff;
                        pixelCount++;
                    }
                }
                
                // è¿”å›å¹³å‡å·®å¼‚ï¼Œè¿™å¯ä»¥ä½œä¸ºæ—‹è½¬çš„æŒ‡æ ‡
                return pixelCount > 0 ? diffSum / pixelCount : 0;
            }
            
            function analyzeFrame() {
                if (!gameActive) return;
                
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    // ç»˜åˆ¶å½“å‰è§†é¢‘å¸§åˆ°ç”»å¸ƒ
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // è·å–å½“å‰å¸§æ•°æ®
                    const currentFrameData = context.getImageData(0, 0, canvas.width, canvas.height);
                    
                    // è®¡ç®—æ—‹è½¬è§’åº¦
                    const angleChange = calculateRotationAngle(currentFrameData, lastFrameData);
                    
                    // æ£€æµ‹æ˜¯å¦åœ¨æ—‹è½¬
                    isRotating = angleChange > 5; // é˜ˆå€¼ï¼Œå¯è°ƒæ•´
                    
                    // æ ¹æ®æ¸¸æˆè§„åˆ™å¤„ç†æ—‹è½¬
                    if (isRotating) {
                        if (isGifVisible) {
                            // åœ¨3.gifæ˜¾ç¤ºæ—¶æ—‹è½¬ï¼Œå¢åŠ è¿›åº¦
                            progress += 0.5;
                            progressBar.style.width = `${progress}%`;
                            
                            // æ£€æŸ¥æ˜¯å¦èƒœåˆ©
                            if (progress >= 100) {
                                gameWin();
                            }
                        } else {
                            // åœ¨æ›¿æ¢.pngæ˜¾ç¤ºæ—¶æ—‹è½¬ï¼Œæ¸¸æˆå¤±è´¥
                            gameLose("åœ¨æ›¿æ¢.pngæ˜¾ç¤ºæ—¶æ—‹è½¬äº†ï¼");
                        }
                    }
                    
                    // ä¿å­˜å½“å‰å¸§æ•°æ®ç”¨äºä¸‹ä¸€å¸§æ¯”è¾ƒ
                    lastFrameData = currentFrameData;
                }
                
                // ç»§ç»­åˆ†æä¸‹ä¸€å¸§
                requestAnimationFrame(analyzeFrame);
            }
            
            // å¼€å§‹åˆ†æè§†é¢‘å¸§
            analyzeFrame();
        }

        // æ¸¸æˆèƒœåˆ©
        function gameWin() {
            gameActive = false;
            clearTimeout(switchInterval);
            statusText.textContent = "æ­å–œä½ èµ¢äº†ï¼";
            statusText.style.color = "#4CAF50";
            
            // æ˜¾ç¤ºç»“å°¾æ¼”å‡º
            showEndingShow();
        }

        // æ˜¾ç¤ºç»“å°¾æ¼”å‡º
        function showEndingShow() {
            endingShow.classList.add('active');
            endingShowActive = true;
            
            // ä¾æ¬¡æ˜¾ç¤ºä¸‰ä¸ª3.gif
            setTimeout(() => {
                endingGif1.classList.add('active');
            }, 500);
            
            setTimeout(() => {
                endingGif2.classList.add('active');
            }, 1500);
            
            setTimeout(() => {
                endingGif3.classList.add('active');
            }, 2500);
            
            // å¼€å§‹ç”Ÿæˆä¸Šå‡çš„çŒ«çŒ«emoji
            startRisingEmojis();
            
            // 3ç§’åå¼€å§‹æ‰è½éšæœºgifï¼ˆæå‰å¼€å§‹ï¼‰
            setTimeout(() => {
                startFallingGifs();
            }, 3000);
            
            // 10ç§’åè·³è½¬åˆ°endingé¡µé¢
            setTimeout(() => {
                window.location.href = 'ending.html';
            }, 10000);
        }
        
        // ç”Ÿæˆä¸Šå‡çš„çŒ«çŒ«emoji
        function startRisingEmojis() {
            if (!endingShowActive) return;
            
            // åˆ›å»ºçŒ«çŒ«emoji
            const emoji = document.createElement('div');
            emoji.className = 'cat-emoji';
            emoji.textContent = 'ğŸ±';
            
            // éšæœºä½ç½®
            const randomX = Math.random() * (window.innerWidth - 50);
            emoji.style.left = `${randomX}px`;
            
            // æ·»åŠ åˆ°é¡µé¢
            endingShow.appendChild(emoji);
            
            // åŠ¨ç”»ç»“æŸåç§»é™¤
            emoji.addEventListener('animationend', () => {
                emoji.remove();
            });
            
            // éšæœºé—´éš”åå†æ¬¡ç”Ÿæˆï¼ˆå¢åŠ ç”Ÿæˆé¢‘ç‡ï¼‰
            const nextInterval = Math.random() * 250 + 100; // å‡å°‘é—´éš”æ—¶é—´
            setTimeout(startRisingEmojis, nextInterval);
        }
        
        // ç”Ÿæˆæ‰è½çš„éšæœºgif
        function startFallingGifs() {
            if (!endingShowActive) return;
            
            // éšæœºé€‰æ‹©1-16.gif
            const randomGifNumber = Math.floor(Math.random() * 16) + 1;
            const gifSrc = `${randomGifNumber}.gif`;
            
            // åˆ›å»ºgifå…ƒç´ 
            const fallingGif = document.createElement('img');
            fallingGif.className = 'falling-gif';
            fallingGif.src = gifSrc;
            
            // éšæœºä½ç½®
            const randomX = Math.random() * (window.innerWidth - 200);
            fallingGif.style.left = `${randomX}px`;
            
            // æ·»åŠ åˆ°é¡µé¢
            endingShow.appendChild(fallingGif);
            
            // åŠ¨ç”»ç»“æŸåç§»é™¤
            fallingGif.addEventListener('animationend', () => {
                fallingGif.remove();
            });
            
            // éšæœºé—´éš”åå†æ¬¡ç”Ÿæˆ
            const nextInterval = Math.random() * 800 + 400;
            setTimeout(startFallingGifs, nextInterval);
        }

        // æ¸¸æˆå¤±è´¥
        function gameLose(reason) {
            gameActive = false;
            clearTimeout(switchInterval);
            window.location.href = 'lose3.html';
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            gameActive = true;
            progress = 0;
            imageSize = 400;
            progressBar.style.width = "0%";
            imageElement.style.width = `${imageSize}px`;
            imageElement.style.height = `${imageSize}px`;
            gifElement.style.width = `${imageSize}px`;
            gifElement.style.height = `${imageSize}px`;
            gameOver.classList.remove('active');
            statusText.textContent = "å‡†å¤‡å¼€å§‹...";
            statusText.style.color = "#663F2A";
            
            // é‡æ–°å¼€å§‹å›¾ç‰‡åˆ‡æ¢
            isGifVisible = false;
            imageElement.style.opacity = 1;
            gifElement.style.opacity = 0;
            switchImages();
        }

        // å¼€å‘è€…æ¨¡å¼æ¿€æ´»å‡½æ•°
        function activateDevMode() {
            console.log('å¼€å‘è€…æ¨¡å¼æ¿€æ´»');
            gameActive = false;
            clearTimeout(switchInterval);
            statusText.textContent = "å¼€å‘è€…æ¨¡å¼æ¿€æ´»ï¼";
            statusText.style.color = "#DC7F43";
            
            // æ˜¾ç¤ºç»“å°¾æ¼”å‡º
            showEndingShow();
        }

        // æ·»åŠ æ ‡é¢˜åŠ¨ç”»
        function animateTitle() {
            const letters = document.querySelectorAll('.title span');
            let currentIndex = 0;

            function animateNext() {
                if (currentIndex < letters.length) {
                    letters[currentIndex].style.animation = 'none';
                    letters[currentIndex].offsetHeight; // è§¦å‘é‡ç»˜
                    letters[currentIndex].style.animation = 'jump 0.5s ease-in-out';
                    currentIndex++;
                } else {
                    currentIndex = 0;
                }
            }

            // åˆå§‹åŠ¨ç”»
            animateNext();

            // æ¯500msè§¦å‘ä¸‹ä¸€ä¸ªå­—æ¯çš„åŠ¨ç”»
            setInterval(animateNext, 500);
        }

        // åœ¨é¡µé¢åŠ è½½æ—¶å¯åŠ¨æ ‡é¢˜åŠ¨ç”»
        window.addEventListener('load', animateTitle);

        // ä¿®æ”¹èƒœåˆ©åçš„è·³è½¬
        function onVictory() {
            window.location.href = 'victory.html';
        }

        // åˆå§‹åŒ–
        async function init() {
            await setupCamera();
            detectRotation();
            
            // 3ç§’åå¼€å§‹æ¸¸æˆ
            setTimeout(() => {
                switchImages();
            }, 3000);
            
            // æ·»åŠ é‡æ–°å¼€å§‹æŒ‰é’®äº‹ä»¶
            restartButton.addEventListener('click', restartGame);
        }

        // å¯åŠ¨åº”ç”¨
        init();
    </script>
</body>
</html> 